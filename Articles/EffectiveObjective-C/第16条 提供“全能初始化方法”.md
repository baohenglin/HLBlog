## 第 16 条： 提供“全能初始化方法”

所有对象均要初始化。在初始化时，有些对象可能无须开发者向其提供额外信息，不过一般来说还是要提供的。通常情况下，对象若不知道必要的信息，则无法完成其工作。以 iOS 的 UI 框架 UIKit 为例，其中有个类叫做 UITableViewCell，初始化该类对象时，需要指明其样式及标识符，标识符能够区分不同类型的单元格。由于这种对象的创建成本较高，所以绘制表格时可依照标识符来**复用**，以**提升程序效率**。我们把这种可为对象提供必要信息以便其能完成工作的初始化方法叫做“**全能初始化方法**”（designated initializer）。

如果创建类实例的方式不止一种，那么这个类就会有多个初始化方法。这当然很好，不过仍然要在其中选定一个作为全能初始化方法，令其他初始化方法都来调用它。 NSDate 就是这例子，其初始化方法如下：

```
- (id)init;
- (id)initWithString:(NSString *)string;
- (id)initWithTimeIntervalSinceNow:(NSTimeInterval)seconds;
- (id)initWithTimeInterval:(NSTimeInterval)seconds sinceDate:(NSDate *)refDate;
- (id)initWithTimeIntervalSinceReferenceDate:(NSTimeInterval)senconds;
- (id)initWithTimeIntervalSince1970:(NSTimeInterval)seconds;
```

正如该类的文档所述的那样，在上面几个初始化方法中，“initWithTimeIntervalSinceReferenceDate:”是全能初始化方法。也就是说，其余的初始化方法都要调用它。于是，**只有在全能初始化方法中，才会存储内部数据**。这样的话，**当底层数据存储机制改变时，只需修改此方法的代码就好，无须改动其他初始化方法**。

比如说，要编写一个表示矩形的类。其接口可以这样写：

```
#import <Foundation/Foundation.h>

@interface EOCRectangle : NSObject
@property (nonatomic, assign, readonly) float width;
@property (nonatomic, assign, readonly) float height;
@end
```

根据第18条中的建议，我们把属性声明为只读。不过这样一来，外界就无法设置 Rectangle 对象的属性了。开发者可能会提供初始化方法以设置这两个属性：

```
- (id)initWithWidth:(float)width andHeight:(float)height {
    if ((self = [super init])) {
        _width = width;
        _height = height;
    }
    return self;
}
```

可是，如果有人用 [[EOCRectangle alloc]init] 来创建矩形会如何呢？这么做是合乎规则的，因为 EOCRectangle 的超类 NSObject 实现了这个名为 init 的方法，调用完该方法后，全部实例变量都将设为0（或设置成符合其数据类型且与0等价的值）。如果把 alloc 方法分配好的 EOCRectangle 交由此方法来初始化，那么矩形的宽度与高度就是 0，因为全部实例变量都设为 0 了。这也可能正是你想要的效果，不过此时我们一般希望能自己设定默认的宽度与高度值，或是抛出异常，指明**本类实例必须用“全能初始化方法”来初始化**。也就是说，在 EOCRectangle 这个例子中，应该像下面这样，参照其中一种版本来覆写 init 方法：

```
// Using default values
- (id)init {
    return [self initWithWidth: 5.0f andHeight: 10.0f];
}
//Throwing an exception
- (id)init {
    @throw [NSException exceptionWithName: NSInternalInconslstencyException reason:@"Must use initWithWidth:andHeight: instead." userInfo: nil];
}
```

请注意，设置默认值的那个 init 方法调用了全能初始化方法。如果采用这个版本来覆写，那么也可以直接在其代码中设置_width与_height 实例变量的值。然而，若是类的底层存储方式变了（比如开发者决定把宽度与高度一起放在某结构体中），则 init 与全能初始化方法设置数据所用的代码就都要修改。在本例这种简单的情况下没有太大问题，**但是如果类的初始化方法有很多，而且待初始化的数据也较为复杂，那么这样做就麻烦得多。很容易就忘了修改其中的某个初始化方法，从而导致各初始化方法之间相互不一致**。






